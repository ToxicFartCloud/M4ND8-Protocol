# =====================================================================
# ui.yaml — UI Rules & Tokens (M4ND8 Protocol v4.4, Control Plane)
# Baseline, not blueprint. Enforce accessibility, coherency & contract invariants;
# do NOT standardize away custom brand or visuals.
#
# Updates v4.2 (Research-Backed):
#   - Renamed protocol to 'm4nd8_pro'.
#   - Added 'AI_SLOP' and 'UI_COHERENCY' definitions to prevent entropy.
#   - Enforced 'Nielsen Heuristics' in verification mapping.
#   - Hardened token binding (no raw hex/inline styles).
# =====================================================================
meta:
  version: "4.4"
  description: "Baseline UI system: minimum accessibility, coherency, and consistency guarantees. Creative freedom is allowed—and expected."
  intent: "This file defines the MINIMUM bar (MUST). It is NOT a visual blueprint."
  applies_if: "manifest.yaml → features.ui == true"
  audit_doc: "m4nd8_pro/ui_checklist_uni.md"
  conformance_terms:
    MUST: "Non-negotiable invariant for accessibility/compliance/coherency."
    SHOULD: "Recommended pattern; may be overridden with rationale."
    MAY: "Optional; purely stylistic."

# ---------------------------- Definition of Terms --------------------------------
definitions:
  UI_COHERENCY:
    description: "All UI surfaces—primary views, modals, menus, settings panels, error dialogs—MUST share the same design language, tokens, and interaction patterns. No surface may fall back to default, framework-native, or unstyled components."
    enforcement: "Incoherent UI = HARD_STOP → ESCALATE (per director.yaml)."
  AI_SLOP:
    description: "Code that is bloated, duplicated, insecure, inconsistent, or misaligned with project context. Includes hardcoded values, non-tokenized styles, and 'magic numbers'."
    enforcement: "Detection of Slop = HARD_STOP."

policy:
  creative_latitude:
    statement: "Teams MAY define brand and product-specific look & feel. Audits check invariants (contrast, focus, keyboard nav, token usage)—not aesthetics."
    non_prescriptive_examples:
      - "Color ramps, shadows, and shapes are freeform if contrast & states meet AA."
      - "Typography families/sizes may differ if minimums are met."
      - "Layout density may vary if hit-target and keyboard navigation are preserved."
  change_behavior:
    do_not_normalize_visuals: true           # Workers MUST NOT replace custom visuals with 'standard' ones
    preserve_existing_components: true       # Do not delete/rename existing UI without explicit deprecation
    require_deprecation_record: true         # Deprecations need a cofo Change Note with rationale
  extension_points:
    custom_tokens_allowed: true
    custom_token_namespaces:
      - "brand/*"                            # e.g., brand/primary-700
      - "app/*"                              # e.g., app/sidebar-bg
    variant_policy:
      components_may_add_variants: true      # e.g., button/ghost, button/brand
      forbidden_variant_collision: true      # Do not silently overwrite existing variants

accessibility:
  wcag_version: "2.2"
  target_level: "AA"
  min_contrast:
    text: 4.5
    large_text: 3.0
    ui_components: 3.0
    graphical_objects: 3.0
  focus_visible: true
  motion_reduction_respect: true             # respect prefers-reduced-motion
  keyboard_navigation_required: true
  hit_target_min_size_px: 44
  error_prevention_legal_financial: true
  color_alone_is_not_information: true
  directionality_supported: ["ltr","rtl"]

modes:
  - id: "light"
    description: "Default"
  - id: "dark"
    description: "Dark mode"
  - id: "hc"
    description: "High-contrast mode (AA+ with stronger ramps)"

design_tokens:
  color:
    semantic:
      bg/default:       { light: "#FFFFFF", dark: "#0B0B0C", hc: "#000000" }
      bg/subtle:        { light: "#F7F7F8", dark: "#121315", hc: "#000000" }
      surface/raised:   { light: "#FFFFFF", dark: "#141518", hc: "#000000" }
      text/default:     { light: "#111114", dark: "#F3F4F6", hc: "#FFFFFF" }
      text/muted:       { light: "#5B5E66", dark: "#A7ADB7", hc: "#FFFFFF" }
      text/inverse:     { light: "#FFFFFF", dark: "#0B0B0C", hc: "#000000" }
      brand/primary:    { light: "#155EEF", dark: "#4C8DFF", hc: "#00A3FF" }
      brand/on-primary: { light: "#FFFFFF", dark: "#0B0B0C", hc: "#000000" }
      accent:           { light: "#22B07D", dark: "#3ED0A0", hc: "#00FFB3" }
      danger:           { light: "#D92D20", dark: "#FF5C5C", hc: "#FF3333" }
      warning:          { light: "#F59E0B", dark: "#FFB547", hc: "#FFC700" }
      success:          { light: "#16A34A", dark: "#25C168", hc: "#00E676" }
      border/default:   { light: "#E5E7EB", dark: "#2A2D33", hc: "#FFFFFF" }
      border/strong:    { light: "#C9CCD1", dark: "#3A3E45", hc: "#FFFFFF" }
      focus/outline:    { light: "#1D4ED8", dark: "#60A5FA", hc: "#00B2FF" }
  typography:
    family/sans: ["Inter", "system-ui", "-apple-system", "Segoe UI", "Roboto", "Arial", "sans-serif"]
    family/mono: ["JetBrains Mono", "ui-monospace", "SFMono-Regular", "Menlo", "Consolas", "monospace"]
    size:
      xs: 12
      sm: 14
      md: 16
      lg: 18
      xl: 20
      "2xl": 24
      "3xl": 30
    line_height:
      compact: 1.25
      normal: 1.5
      relaxed: 1.7
    weight:
      regular: 400
      medium: 500
      semibold: 600
      bold: 700
  spacing:
    scale_px: [4, 8, 12, 16, 20, 24, 32, 40, 48, 64]
    grid_unit_px: 8
  radius:
    sm: 6
    md: 10
    lg: 16
    pill: 999
  elevation:
    none: "shadow: none"
    sm: "0 1px 2px rgba(0,0,0,.08)"
    md: "0 4px 10px rgba(0,0,0,.12)"
    lg: "0 10px 24px rgba(0,0,0,.16)"
  motion:
    duration_ms:
      fast: 100
      normal: 180
      slow: 260
      max_allowed: 300                  # no UI animation exceeds this
    easing:
      standard: "cubic-bezier(0.2, 0, 0, 1)"
      emphasized: "cubic-bezier(0.2, 0, 0, 1.2)"
    frame_budget_ms: 16.7               # 60fps target; >16.7ms is flagged
    expensive_effects:
      box_shadow_layers_max: 3
      blur_radius_max: 8
    reduce_motion_scale: 0.0

layout:
  breakpoints_px:
    sm: 640
    md: 768
    lg: 1024
    xl: 1280
    "2xl": 1536
  container_max_width_px:
    sm: 600
    md: 720
    lg: 960
    xl: 1140
    "2xl": 1320
  grid:
    columns: 12
    gutter_px: 24
    margin_px: 16

effects:
  transparency:
    allow_text_on_translucent: false         # text must sit on opaque surfaces
    min_backdrop_contrast_ratio: 4.5         # if overlay, enforce contrast vs. backdrop
    require_edge_separation: true            # add border/overlay to separate layers
  blur:
    allowed: false                           # enable only with explicit spec/cofo citation
    performance_budget_ms: 4                 # per frame; avoid hitching on low-end devices

components:
  allowed:
    - button
    - input
    - textarea
    - select
    - checkbox
    - radio
    - switch
    - tooltip
    - popover
    - dialog
    - sheet
    - toast
    - navbar
    - sidebar
    - card
    - table
    - pagination
    - tabs
    - breadcrumb
    - avatar
    - badge
    - banner
    - alert
  rules:
    naming:
      pattern: "kebab-case"
      disallow_prefixes: ["tmp-", "demo-", "example-"]
    anatomy:
      button:
        requires_slots: ["label"]
        optional_slots: ["icon"]
      dialog:
        requires_slots: ["title","content","actions"]
    a11y:
      button:
        focus_outline_token: "focus/outline"
        min_size_px: 36
        keyboard_activation: ["Enter","Space"]
      input:
        label_required: true
        describedby_error_required: true
      tooltip:
        dismissible: true
        hover_and_focus_only: true
      dialog:
        aria_roles: ["dialog"]
        focus_trap_required: true
        escape_to_close: true
    table:
      features_required:
        - fixed_header
        - column_resize
        - optional_column_lock
      density_modes:
        - compact
        - comfortable
        - spacious
      min_hit_target_px: 36
      keyboard_nav_required: true
  states:
    required:
      - hover
      - focus
      - active
      - disabled
      - invalid
      - loading
    contrast_requirements:
      text_on_primary_min: 4.5
      text_on_surface_min: 4.5
      icon_on_primary_min: 3.0
      disabled_exemption: true

feedback:
  visual:
    immediate_state_change_required: true
  auditory:
    allowed: true
    non_blocking: true
    provide_mute_toggle: true
  haptic:
    allowed: true
    platform: ["ios","android"]
    intensity_scale: ["light","medium"]      # avoid heavy by default
  copy_feedback:
    success_patterns: ["Saved", "Done"]
    error_patterns: ["Try again", "Check connection"]

assets_policy:
  images_allowed: false                      # Only if explicitly required by spec/cofo
  icons:
    source: "internal"                       # internal | external
    license: "compatible"
    size_px: { sm: 16, md: 20, lg: 24 }
  illustrations:
    allowed: false
  brand:
    logo_required: false

theming:
  algorithm: "semantic-aliasing"             # components bind to semantic tokens
  fallback_mode: "light"
  user_prefers_respected: true               # prefers-color-scheme honored

constraints:
  require_semantic_tokens: true
  forbid_raw_hex_in_components: true         # Critical Anti-Slop rule
  forbid_inline_styles_in_components: true   # Critical Anti-Slop rule
  forbid_text_as_button_without_role: true
  enforce_rtl_support: true
  normalization_prohibited: true             # Do NOT 'standardize' custom UI
  preserve_existing_ui_files: true           # Mass deletion/rename blocked without deprecation
  forbid_text_on_translucent: true

verification:
  scope: "invariants_only"                   # audits check accessibility & contract, not appearance
  audit:
    checklist: "m4nd8_pro/ui_checklist_uni.md"
    required_when_feature_true: true
    mapping:
      - id: "WCAG-2.2-AA-contrast"
        tokens: ["text/default","text/inverse","brand/on-primary","border/strong"]
        min_ratio: 4.5
      - id: "Focus-Visible"
        tokens: ["focus/outline"]
        must_exist: true
      - id: "Motion-Reduction"
        pref: "prefers-reduced-motion"
        reduce_to: "fade/opacity-only"
      - id: "Keyboard-Nav"
        components: ["button","input","select","dialog","tabs","table"]
        required_keys: ["Tab","Shift+Tab","Enter","Space","ArrowKeys","Escape"]
      - id: "Hit-Target-Size"
        min_px: 44
      - id: "Frame-Budget"
        max_frame_ms: 16.7
      - id: "No-Text-On-Glass"
        require_opaque_text_background: true
      - id: "NO_AI_SLOP"
        check: "Code must not contain duplicated logic, hardcoded secrets, or non-tokenized styles."
      - id: "HEURISTIC_COMPLIANCE"
        check: "UI must satisfy Nielsen’s core heuristics (visibility, control, error prevention)."
      - id: "CHAT_UI_BASELINE"
        check: "If the app is conversational, it must implement the modern_chat_ui reference pattern."
      - id: "NO_DEFAULT_COMPONENTS"
        check: "Zero instances of unstyled <button>, <input>, or browser-native dialogs."
      - id: "TOKEN_CONSISTENCY"
        check: "All spacing, color, and typography values must resolve to design_tokens."
      - id: "STATE_UNIFORMITY"
        check: "Hover, focus, active, disabled, and error states must be implemented consistently."

overrides:
  allowed: true
  must_not_break:
    - "accessibility.target_level"
    - "design_tokens.color.semantic.text/default"
    - "constraints.require_semantic_tokens"
    - "constraints.forbid_raw_hex_in_components"
    - "constraints.forbid_inline_styles_in_components"
    - "constraints.enforce_rtl_support"
    - "constraints.normalization_prohibited"
    - "constraints.preserve_existing_ui_files"
